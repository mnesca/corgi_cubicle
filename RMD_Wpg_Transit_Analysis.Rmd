---
title: "Playing Around with Transit Data"
author: "Marcello Nesca"
date: "July 2 2019"
output: github_document
---

## Motivation(s) & Objectives

The idea of this practice dataset is:  
  1) to upkeep my data science skills in R  
  2) playing with version control using Github  
  3) Store my thoughts on data analysis  
  4) i want to practice more on Tidyverse code and stop using BASE R coding  


```{r loading packages, include=FALSE}
library(here) 
library(tidyverse)
library(stringr)
library(lubridate)
```

## Loading Datasets

I have obtained this dataset from the City of Winnipeg open dataset archive I will be concentrating on utilizing the Transit-passups for this practice project.  Since this dataset gets updated daily, I have gotten this dataset in June 29th 2019.

Ref: <https://data.winnipeg.ca/Transit/Transit-Pass-ups/mer2-irmb>

```{r loading data, include=TRUE}
transitdata <- read_csv(here::here("data", "Transit_Pass-ups.csv"))
```

## Data Cleaning and Checking Variables

Here I want to describe what my variables initially look like before further analysis. We first need to see what variables are included without continiously looking at the dataframe.  The idea is to try to be efficient in your work. 
Here are a list of the variables: 
```{r sumvar}
sumvar <- summary(transitdata)
print(sumvar)
```

```{r Descriptive Analysis, include=TRUE}
ggplot(transitdata) +
  geom_bar(aes("Pass-Up Type")) +
  xlab("Type of bus that passed")
```

It seems this produced an error that I am trying to fix, the error in this case is that its outputting the total count of the variable under Route Destination which is not useful at all. I will try to fix this.

The issue was that the variables were characters to which i have to change to factors.

AAAAND... urgggg! It seems like transforming the variables didnt work either!!


```{r Mutating character variables to Factors and renaming, include=TRUE}
## I know this next bit of code is inefficient so i have to trouble shoot it later.
transitdata <- transitdata %>% 
  dplyr::rename(RouteDestination = `Route Destination`) %>%
  dplyr::rename(RouteName = `Route Name`) %>%
  dplyr::rename(PassUpType = `Pass-Up Type`) %>%
  dplyr::rename(RouteNumber = `Route Number`) %>%
  dplyr::rename(PassUpID = `Pass-Up ID`) %>%
  mutate_at(vars("RouteDestination", "RouteName", "PassUpType", "RouteNumber"), as.factor)
```

UPDATE: 07-21-2019:
So I finally figured out why my GGPLOT geom bar is continiously breaking -- it took me a week or so to figure this out.  It is because GGPLOT *CANNOT* have spaces in the variables.  Furthermore, spaces between variables is not good coding practice anyways, so... City of Winnipeg, do *NOT* put spaces in your variables.

```{r GGPLOT Test, include=TRUE}
ggplot(transitdata) +
  geom_bar(aes(PassUpType, fill = PassUpType)) +
  xlab("Type of bus that passed")
```

UPDATE 07-31-2019:
definitely by practice, cleaning and visualizing data is a circular process. 

Below is where i changed longitude and latitude

```{r Separating variables!, include=TRUE}
transitdata <- transitdata %>%
  separate(Location, into = c("Extra", "Lat1", "Long1"), sep = " ") %>%
  separate(Lat1, into = c("Extra1", "Latitude"), sep = 1) %>%
  separate(Long1, into = c("Longitude", "Extra2"), sep = -1) %>%
  select(-Extra, -Extra1, -Extra2)
```

Here is where we clean the time variable - i want to lubridate the time variable first, then split up time and date

```{r Mutating Time, include=TRUE}
transitdata <- transitdata %>%
  mutate(Time = mdy_hms(Time)) %>%
  separate(Time, into = c("Date", "Clock"), sep = " ")
```

```{r Changing Dates, include=TRUE}
transitdata <- transitdata %>%
  mutate(year = year(Date), 
         month = month(Date), 
         day = day(Date),
         ) %>%
  mutate_at(vars("year", "month"), as.factor) 
# i had made a business decision to create date as a numerical variable instead of a categorical variable -- because i want to analyze the average date within a month.
```

It seems that I have cleaned everything I wish to clean, I have separated all the variables in their component parts including the dates! So now lets explore some data finally!

```{r GGPLOT Data Exploration - year, include=TRUE}
ggplot(transitdata) +
  geom_bar(aes(year, fill = year)) +
  xlab("Year")
```

Wow! Interesting exploratory information! The rate of pass-ups are increasing per year since 2015! however in 2015 it did go down from 2014. 2019 is a half year since i downloaded the data end of June 2019.

questions derived from this analysis (either answerable or unanswerable via data):  
1) what caused the increase in pass ups from 2014-2018?  
2) is it possible to join another table for extra insights, if so, what would be the common id?

```{r GGPLOT Data Exploration - month, include=TRUE}
ggplot(transitdata) +
  geom_bar(aes(month, fill = month)) +
  xlab("Month")
```

and this is clearly very interesting! most of the passups occur when -- you guessed it! school is starting!

```{r Now lets see other variables!, include=TRUE}
ggplot(transitdata) +
  geom_bar(aes(RouteDestination)) +
  coord_flip() +
  xlab("Where the bus went")

ggplot(transitdata) +
  geom_bar(aes(RouteName)) +
  coord_flip() +
  xlab("Name of the Route")
```

I cannot seem to find a way to properly sort categorical variables but ill definitely find out by next time! There are way too many values for these variables... Now a new problem to solve!

UPDATE 08-10-2019:  
some possible solutions while talking to Ran!  
1) derive only the top 10 and bottom 10 passups so filter by most frequent and least frequent  
2) create a category for day of the week "Monday tuesday etc"  
3) create a category for subgroup by region in winnipeg  
4) create a category for what type of speed bus "super express, rapid transit, etc"

```{r adding categories for bus speed, include=TRUE}
transitdata <- transitdata %>%
  mutate(bus_speed = ifelse(RouteNumber %in% c(137,160,161,162,163,170,180,181,183,185), 'RapidTransit',
                            ifelse(RouteNumber %in% c(101,102,109,110), 'Dart',
                                   ifelse(RouteNumber %in% c(1,2,3), 'DowntownSpirit',
                                          ifelse(RouteNumber %in% c(21,22,24,28,30,31,32,40,41,42,46,48,54,57,58,59,64,65,67), 'Express',
                                                 ifelse(RouteNumber %in% c(25,34,35,36), 'SuperExpress', 'Regular'))))))
  
```

number 4 check! Now lets visualize!

```{r checking new variable i created, include=TRUE}
ggplot(transitdata) +
  geom_bar(aes(bus_speed, fill = bus_speed)) +
  facet_wrap(~ year, nrow = 4) +
  theme(axis.text.x=element_blank(),
        axis.ticks.x=element_blank()) +
  xlab("Type of bus speed") +
  ylab("count of passups")

# two categorical variables - dotmap by year
ggplot(transitdata) +
  geom_count(aes(year, bus_speed))

# two categorical variables - heatmap by month
transitdata %>% 
  count(month, bus_speed) %>%  
  ggplot(aes(month, bus_speed)) +
    geom_tile(aes(fill = n))

#Finding out which busses are the culprits! 
transitdata %>%
  filter(bus_speed %in% c('Regular')) %>%
  ggplot(aes(RouteNumber)) +
    geom_bar() +
    xlab("RouteNumber")

transitdata %>%
  filter(bus_speed %in% c('RapidTransit')) %>%
  ggplot(aes(RouteNumber, fill = RouteNumber)) +
    geom_bar() +
    facet_wrap(~ month, nrow = 4) +
    theme(axis.text.x=element_blank(),
        axis.ticks.x=element_blank()) +
    xlab("RouteNumber")

transitdata %>%
  filter(bus_speed %in% c('Express')) %>%
  ggplot(aes(RouteNumber, fill = RouteNumber)) +
    geom_bar() +
    xlab("RouteNumber")

transitdata %>%
  filter(bus_speed %in% c('SuperExpress')) %>%
  ggplot(aes(RouteNumber, fill = RouteNumber)) +
    geom_bar() +
    xlab("RouteNumber")

transitdata %>%
  group_by(RouteNumber) %>%
  filter(n() >= 4000) %>%
  ggplot(aes(RouteNumber, fill = RouteNumber)) +
    geom_bar() +
    xlab("RouteNumber")
```

```{r trying a new visualization}

```

